<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>REST API Result</title>
<style>
body { margin:0; padding:0; font-family:sans-serif; background:#f5f5f5; overflow:hidden; height:100vh; display:flex; flex-direction:column; box-shadow:0 0 0 1px #888; }
.title-bar { display:flex; align-items:center; justify-content:space-between; height:32px; background:#e8e8e8; color:#333; border-bottom:1px solid #ccc; -webkit-app-region:drag; user-select:none; flex-shrink:0; }
.title-bar-drag-region { flex:1; padding-left:12px; font-size:13px; font-weight:500; }
.title-bar-buttons { display:flex; -webkit-app-region:no-drag; }
.title-btn { background:transparent; border:none; color:#333; width:46px; height:32px; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background 0.15s; }
.title-btn:hover { background:#d0d0d0; }
.title-btn.close-btn { font-size:22px; font-weight:300; line-height:1; }
.title-btn.close-btn:hover { background:#e81123; color:#fff; }
.title-btn.close-all-btn { width:auto; padding:0 12px; font-size:12px; border-right:1px solid #ccc; }
.title-btn.close-all-btn:hover { background:#dc3545; color:#fff; }
.title-btn.minimize-btn { font-size:18px; }
.container { width:100%; margin:0; background:#fff; padding:0; border-radius:0; box-shadow:none; flex:1; overflow:hidden; box-sizing:border-box; display:flex; flex-direction:column; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0; border-bottom:2px solid #0066cc; padding:20px 20px 10px 20px; flex-shrink:0; }
h1 { margin:0; color:#333; font-size:18px; }
.action-btn { padding:4px 8px; font-size:12px; cursor:pointer; }
.action-btn.sf-link { background:#0066cc; color:#fff; }
#content { flex:1; overflow:auto; padding:20px; position:relative; }
pre { background:#f8f8f8; padding:15px; border-radius:4px; overflow:auto; font-family:monospace; font-size:13px; line-height:1.5; border:1px solid #ddd; cursor:text; user-select:text; max-height:none; }
pre:focus { outline:none; }
.error { background:#f8d7da; color:#721c24; padding:15px; border-radius:4px; border:1px solid #f5c6cb; }
.search-box { position:absolute; top:10px; right:10px; background:#fff; border:2px solid #0066cc; border-radius:4px; padding:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:1000; display:none; }
.search-box input { border:1px solid #ccc; padding:4px; margin-right:4px; font-size:12px; }
.search-box button { background:#0066cc; color:white; border:none; padding:4px 8px; cursor:pointer; font-size:12px; }
.search-box button:hover { background:#0052a3; }
.search-highlight { background:#ffff00; color:#000; }
.search-current { background:#ff6600; color:#fff; }
</style>
</head>
<body>
<div class="title-bar">
    <div class="title-bar-drag-region">REST API Result</div>
    <div class="title-bar-buttons">
        <button id="closeAllBtn" class="title-btn close-all-btn" title="Close All Popups">âœ• Close All</button>
        <button class="title-btn close-btn" onclick="window.close()" title="Close">Ã—</button>
    </div>
</div>
<div class="container">
    <div class="header">
        <h1>REST API Result</h1>
        <div style="display:flex; gap:8px;">
            <button id="copyBtn" class="action-btn" style="display:none;">ðŸ“‹ Copy</button>
            <button id="exportBtn" class="action-btn" style="display:none;">ðŸ“„ Export JSON</button>
            <button id="openInSF" class="action-btn sf-link" style="display:none;">Open in Salesforce</button>
        </div>
    </div>
    <div id="content">Loading...</div>
    <div id="searchBox" class="search-box">
        <input type="text" placeholder="Search..." id="searchInput">
        <span id="matchCount" style="font-size:11px; color:#666; margin-right:4px;"></span>
        <button onclick="findNext()" title="Find Next (Enter)">â†“</button>
        <button onclick="findPrev()" title="Find Previous (Shift+Enter)">â†‘</button>
        <button onclick="closeSearch()" title="Close (Escape)">âœ•</button>
    </div>
</div>

<script>
const { ipcRenderer } = require('electron');

// Search functionality
let currentMatches = [];
let currentMatchIndex = -1;
let currentSearchText = '';

function openSearch() {
    const searchBox = document.getElementById('searchBox');
    const input = document.getElementById('searchInput');
    searchBox.style.display = 'block';
    input.focus();
}

function closeSearch() {
    const searchBox = document.getElementById('searchBox');
    searchBox.style.display = 'none';
    clearHighlights();
}

function clearHighlights() {
    const content = document.getElementById('content');
    const highlights = content.querySelectorAll('.search-highlight, .search-current');
    highlights.forEach(span => {
        const parent = span.parentNode;
        parent.replaceChild(document.createTextNode(span.textContent), span);
        parent.normalize();
    });
    document.getElementById('matchCount').textContent = '';
    currentMatches = [];
    currentMatchIndex = -1;
}

function findInContent(searchText, direction = 1) {
    if(!searchText) return;
    
    const content = document.getElementById('content');
    
    // Only rebuild matches if search text changed
    if(currentSearchText !== searchText) {
        clearHighlights();
        currentSearchText = searchText;
        currentMatches = [];
        currentMatchIndex = 0;
        
        highlightMatches(searchText, 0);
    } else {
        // Navigate through existing matches
        currentMatchIndex += direction;
        if(currentMatchIndex >= currentMatches.length) currentMatchIndex = 0;
        if(currentMatchIndex < 0) currentMatchIndex = currentMatches.length - 1;
        
        // Update highlight classes
        const highlights = content.querySelectorAll('.search-highlight, .search-current');
        highlights.forEach((span, index) => {
            span.className = index === currentMatchIndex ? 'search-current' : 'search-highlight';
            if(index === currentMatchIndex) {
                span.id = 'current-search-match';
            } else {
                span.removeAttribute('id');
            }
        });
    }
    
    // Update match counter
    const counter = document.getElementById('matchCount');
    if(currentMatches.length > 0) {
        counter.textContent = `${currentMatchIndex + 1} of ${currentMatches.length}`;
    }
    
    // Scroll to current match
    setTimeout(() => {
        const currentMatch = document.getElementById('current-search-match');
        if(currentMatch) {
            currentMatch.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        }
    }, 10);
}

function highlightMatches(searchText, currentIndex) {
    const content = document.getElementById('content');
    const regex = new RegExp(escapeRegex(searchText), 'gi');
    let matchIndex = 0;
    
    function highlightTextNode(node) {
        if(node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            const matches = [];
            let match;
            regex.lastIndex = 0;
            while((match = regex.exec(text)) !== null) {
                matches.push({ start: match.index, end: match.index + match[0].length, text: match[0] });
            }
            
            if(matches.length > 0) {
                const fragment = document.createDocumentFragment();
                let lastEnd = 0;
                
                matches.forEach(m => {
                    if(m.start > lastEnd) {
                        fragment.appendChild(document.createTextNode(text.substring(lastEnd, m.start)));
                    }
                    
                    const span = document.createElement('span');
                    span.className = matchIndex === currentIndex ? 'search-current' : 'search-highlight';
                    if(matchIndex === currentIndex) {
                        span.id = 'current-search-match';
                    }
                    span.textContent = m.text;
                    fragment.appendChild(span);
                    
                    currentMatches.push(matchIndex);
                    lastEnd = m.end;
                    matchIndex++;
                });
                
                if(lastEnd < text.length) {
                    fragment.appendChild(document.createTextNode(text.substring(lastEnd)));
                }
                
                node.parentNode.replaceChild(fragment, node);
            }
        } else if(node.nodeType === Node.ELEMENT_NODE) {
            if(!node.classList.contains('search-highlight') && !node.classList.contains('search-current')) {
                Array.from(node.childNodes).forEach(child => highlightTextNode(child));
            }
        }
    }
    
    highlightTextNode(content);
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function findNext() {
    const input = document.getElementById('searchInput');
    const searchText = input.value.trim();
    if(searchText) findInContent(searchText, 1);
}

function findPrev() {
    const input = document.getElementById('searchInput');
    const searchText = input.value.trim();
    if(searchText) findInContent(searchText, -1);
}

// Search input handlers
document.getElementById('searchInput').addEventListener('keydown', e => {
    if(e.key === 'Enter') {
        e.preventDefault();
        if(e.shiftKey) {
            findPrev();
        } else {
            findNext();
        }
    } else if(e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
        closeSearch();
    }
});

document.getElementById('searchInput').addEventListener('input', e => {
    const searchText = e.target.value.trim();
    if(searchText) {
        currentSearchText = '';
        findInContent(searchText, 1);
    } else {
        clearHighlights();
    }
});

// Ctrl+F handler
document.addEventListener('keydown', e => {
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        openSearch();
    }
});

// Close all popups button handler (in title bar)
const closeAllBtn = document.getElementById('closeAllBtn');
if (closeAllBtn) {
    closeAllBtn.addEventListener('click', async (e) => {
        e.stopPropagation(); // Prevent drag region interference
        try {
            await ipcRenderer.invoke('close-all-popups');
        } catch (err) {
            console.error('Error closing all popups:', err);
        }
    });
}

// Close window on Escape key (only if search box is not open)
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const searchBox = document.getElementById('searchBox');
        if (searchBox && searchBox.style.display === 'block') {
            // If search is open, close it first
            closeSearch();
        } else {
            // If search is closed, close the window
            window.close();
        }
    }
});

// Request the result data from main process
ipcRenderer.invoke('get-result-data').then(resultData => {
    const contentDiv = document.getElementById('content');
    const openInSFBtn = document.getElementById('openInSF');
    const copyBtn = document.getElementById('copyBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    if (!resultData) {
        contentDiv.innerHTML = '<div class="error">No data available</div>';
        return;
    }
    
    if (resultData.error) {
        contentDiv.innerHTML = `<div class="error">${resultData.error}</div>`;
    } else {
        const pre = document.createElement('pre');
        const jsonText = JSON.stringify(resultData, null, 2);
        pre.textContent = jsonText;
        pre.tabIndex = 0; // Make focusable
        contentDiv.innerHTML = '';
        contentDiv.appendChild(pre);
        
        // Handle Ctrl+A to select only JSON text
        pre.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a') {
                e.preventDefault();
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(pre);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        });
        
        // Auto-focus the pre element and ensure scroll is at top
        setTimeout(() => {
            pre.focus();
            pre.scrollTop = 0;
            // Scroll the content div to top
            const content = document.getElementById('content');
            if (content) {
                content.scrollTop = 0;
            }
        }, 100);
        
        // Show copy button
        copyBtn.style.display = 'block';
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(jsonText);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ“ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            }
        });
        
        // Show export button
        exportBtn.style.display = 'block';
        exportBtn.addEventListener('click', () => {
            const blob = new Blob([jsonText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + 'T' + 
                String(now.getHours()).padStart(2, '0') + '-' + 
                String(now.getMinutes()).padStart(2, '0') + '-' + 
                String(now.getSeconds()).padStart(2, '0');
            const recordId = resultData.Id || 'record';
            a.download = `${recordId}_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // Update title with object type if available
        if (resultData.attributes && resultData.attributes.type) {
            const titleText = `${resultData.attributes.type} - ${resultData.Id || 'Record'}`;
            document.title = titleText;
            document.querySelector('h1').textContent = `${resultData.attributes.type} Record`;
            // Update title bar text
            const titleBarDragRegion = document.querySelector('.title-bar-drag-region');
            if (titleBarDragRegion) {
                titleBarDragRegion.textContent = titleText;
            }
        }
        
        // Show "Open in Salesforce" button if we have an ID
        if (resultData.Id) {
            openInSFBtn.style.display = 'block';
            openInSFBtn.addEventListener('click', async () => {
                try {
                    const config = await ipcRenderer.invoke('get-current-config');
                    if (config && config.instanceUrl) {
                        const url = `${config.instanceUrl}/${resultData.Id}`;
                        await ipcRenderer.invoke('open-external', url);
                    } else {
                        alert('Cannot determine Salesforce URL');
                    }
                } catch (err) {
                    console.error('Error opening Salesforce URL:', err);
                    alert('Failed to open Salesforce URL');
                }
            });
        }
    }
}).catch(err => {
    document.getElementById('content').innerHTML = `<div class="error">Error loading data: ${err.message}</div>`;
});
</script>
</body>
</html>
